<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NAIF â€” Live OTC (PO) & Real Market (TwelveData) â€” v5</title>
<link rel="preconnect" href="https://cdn.socket.io" crossorigin>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" defer></script>
<style>
  :root {
    --bg: #0b1220; --card: rgba(255,255,255,.06); --accent: #00e5a8; --accent2: #38bdf8;
    --text: #e5f4ff; --muted: #91a3b0; --good: #22c55e; --bad: #ef4444; --warn: #f59e0b;
  }
  * { box-sizing: border-box; }
  body { margin:0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, Segoe UI, Tahoma, Arial; }
  header { position:sticky; top:0; z-index: 2; background: rgba(11,18,32,.8); border-bottom: 1px solid rgba(255,255,255,.08); padding:14px 18px; display:flex; justify-content:space-between; align-items:center; gap:12px }
  .logo b{ color: var(--accent); }
  main { padding: 16px; max-width: 1100px; margin: 0 auto; }
  .grid { display:grid; grid-template-columns: 1fr; gap: 14px; }
  @media(min-width: 980px){ .grid { grid-template-columns: 1.15fr .85fr; } }
  .card { background: var(--card); border: 1px solid rgba(255,255,255,.07); border-radius: 14px; padding: 14px; }
  h2 { margin: 0 0 10px; font-size: 18px; color: #cfe9ff; }
  label { font-size: 13px; color: var(--muted); display:block; margin: 8px 0 6px; }
  input, select, textarea { width:100%; background: rgba(255,255,255,.06); color: var(--text);
    border: 1px solid rgba(255,255,255,.12); border-radius: 10px; padding: 10px 12px; font-size: 14px; outline: none; }
  textarea { min-height: 84px; resize: vertical; }
  .row { display:flex; gap:10px; }
  .row > * { flex:1; }
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; }
  .btn { background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: 0; color:#001317; font-weight: 700; padding: 11px 12px; border-radius: 10px; cursor: pointer; width: 100%; }
  .btn.secondary { background: transparent; color: var(--text); border: 1px dashed rgba(255,255,255,.35); }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .status { padding: 10px 12px; border-radius: 10px; font-size: 13px; }
  .ok { background: rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.35); }
  .bad { background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); }
  .warn{ background: rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.35); }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 6px }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; overflow:auto; max-height: 220px; border-radius: 10px; padding:10px; background: rgba(0,0,0,.25); }
  table { width:100%; border-collapse: collapse; }
  th, td { text-align:center; padding:7px 6px; border-bottom: 1px dashed rgba(255,255,255,.08); font-variant-numeric: tabular-nums; }
  th { color:#9fd7ff; font-weight:600; }
  .tiny { font-size: 12px; color: var(--muted); }
  .pill { font-size:12px; padding:4px 8px; border-radius: 999px; border:1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.06) }
</style>
</head>
<body>
<header>
  <div class="logo">NAIF <b>TRADING</b> â€” Live Feeds v5</div>
  <div class="tiny">
    <span id="boot_stamp" class="pill">JS: bootingâ€¦</span>
    <span id="env_info" class="pill"></span>
  </div>
</header>

<main class="grid">
  <!-- Left -->
  <section class="card">
    <h2>Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    <div class="row">
      <button class="btn" data-cmd="switch:otc">Pocket Option â‡¢ OTC</button>
      <button class="btn secondary" data-cmd="switch:td">TwelveData â‡¢ Ø³ÙˆÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠ</button>
    </div>

    <!-- OTC -->
    <div id="pane-otc">
      <div class="row">
        <div>
          <label>Ø§Ù„Ø³ÙŠØ±ÙØ±</label>
          <select id="po_server">
            <option value="DEMO">DEMO â€” wss://demo-api-eu.po.market</option>
            <option value="EUROPA">REAL â€” wss://api-eu.po.market</option>
          </select>
        </div>
        <div>
          <label>Ø±Ù…Ø² OTC (Ù…Ø«Ø§Ù„: <span class="kbd">EURUSD_otc</span>)</label>
          <input id="po_symbol" placeholder="EURUSD_otc" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ (Ø«)</label>
          <select id="po_tf">
            <option value="60" selected>60</option>
            <option value="300">300</option>
            <option value="900">900</option>
          </select>
        </div>
        <div>
          <label>limit</label>
          <input id="po_limit" type="text" value="120" />
        </div>
      </div>

      <label>Ø£Ù„ØµÙ‚ Ø±Ø³Ø§Ù„Ø© 42["auth", {...}] ÙƒØ§Ù…Ù„Ø© (ÙƒÙ…Ø§ Ø±Ø£ÙŠØªÙ‡Ø§)</label>
      <textarea id="po_auth" placeholder='42["auth",{"session":"c6v74skiu8l58ls0k2iesll1fa","isDemo":1,"uid":71923919,"platform":2,"isFastHistory":true,"isOptimized":true}]'></textarea>
      <div class="row">
        <button class="btn" data-cmd="po:connect">Ø§ØªØµØ§Ù„ ÙˆØ¨Ø« Ø§Ù„Ø´Ù…ÙˆØ¹</button>
        <button class="btn secondary" data-cmd="po:disconnect">Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
      <div id="po_status" class="status warn" style="margin-top:10px">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„â€¦</div>
      <div style="margin-top:10px">
        <label>ØªØ´Ø®ÙŠØµ</label>
        <div id="po_log" class="mono"></div>
      </div>
    </div>

    <!-- TwelveData -->
    <div id="pane-td" style="display:none">
      <div class="row">
        <div>
          <label>Ø²ÙˆØ¬ Ø¹Ø§Ù„Ù…ÙŠ (Ù…Ø«Ø§Ù„: <span class="kbd">EUR/USD</span> Ø£Ùˆ <span class="kbd">XAU/USD</span>)</label>
          <input id="td_symbol" placeholder="EUR/USD" />
        </div>
        <div>
          <label>Ø§Ù„ÙØ§ØµÙ„</label>
          <select id="td_interval">
            <option>1min</option><option>5min</option><option>15min</option><option>30min</option><option>1h</option>
          </select>
        </div>
      </div>
      <label>Ù…ÙØªØ§Ø­ TwelveData (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø· â€” Ø§Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Vercel Ù„Ù„Ø¥Ù†ØªØ§Ø¬)</label>
      <input id="td_key" placeholder="TD_API_KEY" />
      <div class="row">
        <button class="btn" data-cmd="td:fetch">Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„Ø¢Ù†</button>
        <button class="btn secondary" data-cmd="td:auto">ØªØ´ØºÙŠÙ„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
      </div>
      <div id="td_status" class="status warn" style="margin-top:10px">Ø§Ø³ØªØ®Ø¯Ù… /api/td_candles Ø¹Ù„Ù‰ Vercel Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙØªØ§Ø­.</div>
    </div>

    <div style="margin-top:12px">
      <button class="btn secondary" data-cmd="test:click">ğŸ”§ Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± â€” ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ¹Ù…Ù„</button>
      <div id="test_result" class="tiny" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- Right -->
  <section class="card">
    <h2>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ©</h2>
    <div class="row">
      <div>
        <div class="tiny">Ø¢Ø®Ø± Ø³Ø¹Ø±</div>
        <div id="last_price" style="font-size:26px; font-weight:800; line-height:1.1; margin-top:4px">â€”</div>
      </div>
      <div>
        <div class="tiny">Ø§Ù„Ù…ØµØ¯Ø±</div>
        <div id="feed_src" style="font-weight:600; margin-top:6px">â€”</div>
      </div>
    </div>
    <div style="overflow:auto; max-height:380px; margin-top:12px">
      <table>
        <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¥Ø·Ø§Ø±</th><th>ÙØªØ­</th><th>Ø£Ø¹Ù„Ù‰</th><th>Ø£Ø¯Ù†Ù‰</th><th>Ø¥ØºÙ„Ø§Ù‚</th><th>Ø­Ø¬Ù…</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div style="margin-top:10px">
      <label>Ø£Ø®Ø·Ø§Ø¡ JavaScript (Ø¥Ù† ÙˆØ¬Ø¯Øª)</label>
      <div id="js_errors" class="mono"></div>
    </div>
    <div class="tiny" style="margin-top:6px" id="hint_line"></div>
  </section>
</main>

<script>
(function boot(){
  const bootStamp = document.getElementById('boot_stamp');
  const envInfo = document.getElementById('env_info');
  bootStamp.textContent = 'JS: loaded âœ“';
  envInfo.textContent = (location.protocol+'//'+location.host)+'  â€¢  '+(new Date()).toLocaleString('ar-EG', { timeZone: 'Asia/Riyadh' });
})();

// ===== Utilities =====
function toAsciiDigits(s){
  if(typeof s !== 'string') return s;
  const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Ù«':'.', 'Ù¬':','};
  return s.replace(/[Ù -Ù©Ù«Ù¬]/g, d => map[d] || d).trim();
}
function logError(e){
  const el = document.getElementById('js_errors');
  const msg = (e && e.message) ? e.message : (''+e);
  el.textContent = '['+new Date().toLocaleTimeString('ar-EG',{hour12:false})+'] ' + msg + '\\n' + el.textContent;
}
window.addEventListener('error', (e) => logError(e.error || e.message));

function pushRow({ts, tf, o, h, l, c, v}){
  const rows = document.getElementById('rows');
  const lastPriceEl = document.getElementById('last_price');
  const tr = document.createElement('tr');
  tr.innerHTML = \`<td>\${new Date(ts).toLocaleTimeString('ar-EG',{hour12:false})}</td>
                   <td>\${tf}</td>
                   <td>\${(+o).toFixed(6)}</td>
                   <td>\${(+h).toFixed(6)}</td>
                   <td>\${(+l).toFixed(6)}</td>
                   <td>\${(+c).toFixed(6)}</td>
                   <td>\${v ?? '-'}</td>\`;
  rows.prepend(tr);
  while(rows.children.length>240) rows.removeChild(rows.lastChild);
  if(c !== undefined && c !== null) lastPriceEl.textContent = (+c).toFixed(6);
}
function clearRows(){ document.getElementById('rows').innerHTML=''; document.getElementById('last_price').textContent='â€”'; }

function setHint(t){ document.getElementById('hint_line').textContent = t || ''; }

// ===== Tabs =====
function switchTab(which){
  const paneO = document.getElementById('pane-otc');
  const paneT = document.getElementById('pane-td');
  const buttons = document.querySelectorAll('[data-cmd^="switch:"]');
  buttons.forEach(b => b.classList.add('secondary'));
  if(which === 'otc'){
    paneO.style.display='block'; paneT.style.display='none';
    document.querySelector('[data-cmd="switch:otc"]').classList.remove('secondary');
  } else {
    paneO.style.display='none'; paneT.style.display='block';
    document.querySelector('[data-cmd="switch:td"]').classList.remove('secondary');
  }
}

// ===== TwelveData =====
let tdTimer = null;
async function fetchTwelveData(){
  try{
    const sym = document.getElementById('td_symbol').value.trim();
    const key = document.getElementById('td_key').value.trim();
    const interval = document.getElementById('td_interval').value;
    if(!sym || !key){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² ÙˆÙ…ÙØªØ§Ø­ TwelveData'); return; }
    document.getElementById('feed_src').textContent = 'TwelveData ' + sym + ' ' + interval;
    setHint('â³ ÙŠØ¬Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† TwelveDataâ€¦');
    const url = \`https://api.twelvedata.com/time_series?symbol=\${encodeURIComponent(sym)}&interval=\${interval}&outputsize=60&apikey=\${encodeURIComponent(key)}\`;
    const r = await fetch(url);
    const data = await r.json();
    if(!data || !data.values){ throw new Error(JSON.stringify(data)); }
    clearRows();
    for(const k of data.values.slice().reverse()){
      pushRow({ ts: new Date(k.datetime+'Z').getTime(), tf: interval, o: k.open, h: k.high, l: k.low, c: k.close, v: k.volume });
    }
    setHint('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù…ÙˆØ¹ Ù…Ù† TwelveData');
  }catch(err){ logError(err); alert('Ø®Ø·Ø£ TwelveData: '+err.message); }
}
function toggleTDAuto(){
  try{
    if(tdTimer){ clearInterval(tdTimer); tdTimer=null; document.querySelector('[data-cmd="td:auto"]').textContent='ØªØ´ØºÙŠÙ„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ'; return; }
    fetchTwelveData();
    tdTimer = setInterval(fetchTwelveData, 5000);
    document.querySelector('[data-cmd="td:auto"]').textContent='Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ';
  }catch(err){ logError(err); }
}

// ===== Pocket Option (Socket.IO) =====
let poSocket = null;
function getPOBaseURL(){
  const server = document.getElementById('po_server').value;
  return server === 'DEMO' ? 'https://demo-api-eu.po.market' : 'https://api-eu.po.market';
}
function poSetStatus(text, cls){ const el = document.getElementById('po_status'); el.textContent=text; el.className='status '+(cls||'ok'); }
function poLog(msg){ const el = document.getElementById('po_log'); el.textContent = '['+new Date().toLocaleTimeString('ar-EG',{hour12:false})+'] '+msg + '\\n' + el.textContent; }

function parseAuth(raw){
  raw = (raw||'').trim();
  if(raw.startsWith('42[')){ const i=raw.indexOf('{'), j=raw.lastIndexOf('}'); if(i>=0 && j>i) return JSON.parse(raw.slice(i, j+1)); }
  if(raw.startsWith('{')) return JSON.parse(raw);
  throw new Error('ØµÙŠØºØ© auth ØºÙŠØ± ØµØ­ÙŠØ­Ø© â€” Ø§Ù„ØµÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ù€ 42[');
}

function subscribeCandles(symbol, period, limit){
  const attempts = [
    ['candles:subscribe', { asset: symbol, period, limit }],
    ['subscribe', { type: 'candles', asset: symbol, period, limit }],
    ['candles:subscribe', { active_id: symbol, timeframe: period, limit }],
    ['candles:subscribe', { asset: symbol, period, limit, market: 'otc' }],
    ['candles:history', { asset: symbol, period, limit }],
    ['history', { type: 'candles', asset: symbol, period, limit }],
  ];
  for(const [ev, payload] of attempts){
    try{ poSocket.emit(ev, payload); poLog('emit '+ev+' '+JSON.stringify(payload)); }catch(e){ poLog('emit error '+ev+' '+e.message); }
  }
}
function handleCandlePayload(p){
  const tf = document.getElementById('po_tf').value + 's';
  if(Array.isArray(p)){
    for(const k of p){
      const raw = (k.ts||k.time||k.t||k.start||Date.now());
      const ts = raw * (((''+raw).length===10)?1000:1);
      pushRow({ ts, tf, o: k.open??k.o, h: k.high??k.h, l: k.low??k.l, c: k.close??k.c, v: k.volume??k.v });
    }
    return;
  }
  if(p && (('open' in p) || ('o' in p))){
    const raw = (p.ts||p.time||p.t||p.start||Date.now());
    const ts = raw * (((''+raw).length===10)?1000:1);
    pushRow({ ts, tf, o: p.open??p.o, h: p.high??p.h, l: p.low??p.l, c: p.close??p.c, v: p.volume??p.v });
  }
}

function connectPO(){
  try{
    if(typeof io === 'undefined'){ poSetStatus('Socket.IO Ù„Ù… ØªÙØ­Ù…Ù‘Ù„ â€” Ø¬Ø±Ù‘Ø¨ ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± http:// Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† file:// Ø£Ùˆ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'bad'); logError('socket.io JS not loaded'); return; }
    const symbol = document.getElementById('po_symbol').value.trim();
    const authRaw = document.getElementById('po_auth').value;
    const period = +toAsciiDigits(document.getElementById('po_tf').value);
    let limit = toAsciiDigits(document.getElementById('po_limit').value);
    limit = parseInt(limit, 10); if(!Number.isFinite(limit) || limit<=0) limit = 120;
    if(!symbol){ alert('Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² OTC Ù…Ø«Ù„ EURUSD_otc'); return; }
    const auth = parseAuth(authRaw);
    clearRows();
    document.getElementById('feed_src').textContent = 'PocketOption OTC ' + symbol + ' (Socket.IO)';
    const url = getPOBaseURL();
    poSocket = io(url, { path: '/socket.io', transports: ['websocket'] });
    poSetStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ '+url, 'warn'); poLog('connectingâ€¦');

    poSocket.on('connect', () => { poLog('connected, emitting auth'); poSocket.emit('auth', auth); });
    poSocket.on('connect_error', (e) => { poSetStatus('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: '+e.message, 'bad'); poLog('connect_error: '+e.message); });
    poSocket.on('disconnect', (reason) => { poSetStatus('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„: '+reason, 'warn'); poLog('disconnect: '+reason); });

    const onAuthorized = () => { poSetStatus('âœ” ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ â€” Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø§Ù„Ø´Ù…ÙˆØ¹', 'ok'); subscribeCandles(symbol, period, limit); };
    poSocket.on('auth_success', onAuthorized);
    poSocket.on('authorized', onAuthorized);
    poSocket.on('auth_ok', onAuthorized);

    poSocket.onAny((event, ...args) => {
      try{
        poLog('event: '+event+'  data: '+JSON.stringify(args[0]).slice(0,400));
        const d = args[0];
        if(event.includes('andle') || Array.isArray(d) || (d && (('open' in d) || ('o' in d)))) handleCandlePayload(d);
      }catch(e){ logError(e); }
    });
  }catch(err){ logError(err); poSetStatus('Ø®Ø·Ø£: '+err.message, 'bad'); }
}
function disconnectPO(){
  try{ if(poSocket){ poSocket.disconnect(); poSocket=null; poSetStatus('ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'warn'); } }catch(e){ logError(e); }
}

// ===== Event Delegation (one listener to rule all buttons) =====
document.body.addEventListener('click', (ev) => {
  const btn = ev.target.closest('[data-cmd]');
  if(!btn) return;
  const cmd = btn.getAttribute('data-cmd');
  setHint('ğŸ‘† CLICK: '+cmd+' @ '+new Date().toLocaleTimeString('ar-EG',{hour12:false}));
  try{
    switch(cmd){
      case 'switch:otc': switchTab('otc'); break;
      case 'switch:td':  switchTab('td');  break;
      case 'po:connect': connectPO(); break;
      case 'po:disconnect': disconnectPO(); break;
      case 'td:fetch': fetchTwelveData(); break;
      case 'td:auto': toggleTDAuto(); break;
      case 'test:click': document.getElementById('test_result').textContent = 'âœ… ØªÙ… Ø§Ù„Ø¶ØºØ· ÙˆØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø­Ø¯Ø« Ø¨Ù†Ø¬Ø§Ø­'; break;
    }
  }catch(e){ logError(e); }
});
</script>
</body>
</html>
