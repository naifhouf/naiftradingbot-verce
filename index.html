<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NAIF — Live OTC (PO) & Real Market (TwelveData) — v5</title>
<link rel="preconnect" href="https://cdn.socket.io" crossorigin>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" defer></script>
<style>
  :root {
    --bg: #0b1220; --card: rgba(255,255,255,.06); --accent: #00e5a8; --accent2: #38bdf8;
    --text: #e5f4ff; --muted: #91a3b0; --good: #22c55e; --bad: #ef4444; --warn: #f59e0b;
  }
  * { box-sizing: border-box; }
  body { margin:0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, Segoe UI, Tahoma, Arial; }
  header { position:sticky; top:0; z-index: 2; background: rgba(11,18,32,.8); border-bottom: 1px solid rgba(255,255,255,.08); padding:14px 18px; display:flex; justify-content:space-between; align-items:center; gap:12px }
  .logo b{ color: var(--accent); }
  main { padding: 16px; max-width: 1100px; margin: 0 auto; }
  .grid { display:grid; grid-template-columns: 1fr; gap: 14px; }
  @media(min-width: 980px){ .grid { grid-template-columns: 1.15fr .85fr; } }
  .card { background: var(--card); border: 1px solid rgba(255,255,255,.07); border-radius: 14px; padding: 14px; }
  h2 { margin: 0 0 10px; font-size: 18px; color: #cfe9ff; }
  label { font-size: 13px; color: var(--muted); display:block; margin: 8px 0 6px; }
  input, select, textarea { width:100%; background: rgba(255,255,255,.06); color: var(--text);
    border: 1px solid rgba(255,255,255,.12); border-radius: 10px; padding: 10px 12px; font-size: 14px; outline: none; }
  textarea { min-height: 84px; resize: vertical; }
  .row { display:flex; gap:10px; }
  .row > * { flex:1; }
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; }
  .btn { background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: 0; color:#001317; font-weight: 700; padding: 11px 12px; border-radius: 10px; cursor: pointer; width: 100%; }
  .btn.secondary { background: transparent; color: var(--text); border: 1px dashed rgba(255,255,255,.35); }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .status { padding: 10px 12px; border-radius: 10px; font-size: 13px; }
  .ok { background: rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.35); }
  .bad { background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); }
  .warn{ background: rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.35); }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 6px }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; overflow:auto; max-height: 220px; border-radius: 10px; padding:10px; background: rgba(0,0,0,.25); }
  table { width:100%; border-collapse: collapse; }
  th, td { text-align:center; padding:7px 6px; border-bottom: 1px dashed rgba(255,255,255,.08); font-variant-numeric: tabular-nums; }
  th { color:#9fd7ff; font-weight:600; }
  .tiny { font-size: 12px; color: var(--muted); }
  .pill { font-size:12px; padding:4px 8px; border-radius: 999px; border:1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.06) }
</style>
</head>
<body>
<header>
  <div class="logo">NAIF <b>TRADING</b> — Live Feeds v5</div>
  <div class="tiny">
    <span id="boot_stamp" class="pill">JS: booting…</span>
    <span id="env_info" class="pill"></span>
  </div>
</header>

<main class="grid">
  <!-- Left -->
  <section class="card">
    <h2>مصدر البيانات</h2>
    <div class="row">
      <button class="btn" data-cmd="switch:otc">Pocket Option ⇢ OTC</button>
      <button class="btn secondary" data-cmd="switch:td">TwelveData ⇢ سوق حقيقي</button>
    </div>

    <!-- OTC -->
    <div id="pane-otc">
      <div class="row">
        <div>
          <label>السيرفر</label>
          <select id="po_server">
            <option value="DEMO">DEMO — wss://demo-api-eu.po.market</option>
            <option value="EUROPA">REAL — wss://api-eu.po.market</option>
          </select>
        </div>
        <div>
          <label>رمز OTC (مثال: <span class="kbd">EURUSD_otc</span>)</label>
          <input id="po_symbol" placeholder="EURUSD_otc" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>الإطار الزمني (ث)</label>
          <select id="po_tf">
            <option value="60" selected>60</option>
            <option value="300">300</option>
            <option value="900">900</option>
          </select>
        </div>
        <div>
          <label>limit</label>
          <input id="po_limit" type="text" value="120" />
        </div>
      </div>

      <label>ألصق رسالة 42["auth", {...}] كاملة (كما رأيتها)</label>
      <textarea id="po_auth" placeholder='42["auth",{"session":"c6v74skiu8l58ls0k2iesll1fa","isDemo":1,"uid":71923919,"platform":2,"isFastHistory":true,"isOptimized":true}]'></textarea>
      <div class="row">
        <button class="btn" data-cmd="po:connect">اتصال وبث الشموع</button>
        <button class="btn secondary" data-cmd="po:disconnect">إيقاف</button>
      </div>
      <div id="po_status" class="status warn" style="margin-top:10px">بانتظار الاتصال…</div>
      <div style="margin-top:10px">
        <label>تشخيص</label>
        <div id="po_log" class="mono"></div>
      </div>
    </div>

    <!-- TwelveData -->
    <div id="pane-td" style="display:none">
      <div class="row">
        <div>
          <label>زوج عالمي (مثال: <span class="kbd">EUR/USD</span> أو <span class="kbd">XAU/USD</span>)</label>
          <input id="td_symbol" placeholder="EUR/USD" />
        </div>
        <div>
          <label>الفاصل</label>
          <select id="td_interval">
            <option>1min</option><option>5min</option><option>15min</option><option>30min</option><option>1h</option>
          </select>
        </div>
      </div>
      <label>مفتاح TwelveData (للاختبار فقط — استخدم دالة Vercel للإنتاج)</label>
      <input id="td_key" placeholder="TD_API_KEY" />
      <div class="row">
        <button class="btn" data-cmd="td:fetch">جلب الشموع الآن</button>
        <button class="btn secondary" data-cmd="td:auto">تشغيل تحديث تلقائي</button>
      </div>
      <div id="td_status" class="status warn" style="margin-top:10px">استخدم /api/td_candles على Vercel لإخفاء المفتاح.</div>
    </div>

    <div style="margin-top:12px">
      <button class="btn secondary" data-cmd="test:click">🔧 زر اختبار — تأكد أن الأزرار تعمل</button>
      <div id="test_result" class="tiny" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- Right -->
  <section class="card">
    <h2>البيانات الحية</h2>
    <div class="row">
      <div>
        <div class="tiny">آخر سعر</div>
        <div id="last_price" style="font-size:26px; font-weight:800; line-height:1.1; margin-top:4px">—</div>
      </div>
      <div>
        <div class="tiny">المصدر</div>
        <div id="feed_src" style="font-weight:600; margin-top:6px">—</div>
      </div>
    </div>
    <div style="overflow:auto; max-height:380px; margin-top:12px">
      <table>
        <thead><tr><th>الوقت</th><th>الإطار</th><th>فتح</th><th>أعلى</th><th>أدنى</th><th>إغلاق</th><th>حجم</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div style="margin-top:10px">
      <label>أخطاء JavaScript (إن وجدت)</label>
      <div id="js_errors" class="mono"></div>
    </div>
    <div class="tiny" style="margin-top:6px" id="hint_line"></div>
  </section>
</main>

<script>
(function boot(){
  const bootStamp = document.getElementById('boot_stamp');
  const envInfo = document.getElementById('env_info');
  bootStamp.textContent = 'JS: loaded ✓';
  envInfo.textContent = (location.protocol+'//'+location.host)+'  •  '+(new Date()).toLocaleString('ar-EG', { timeZone: 'Asia/Riyadh' });
})();

// ===== Utilities =====
function toAsciiDigits(s){
  if(typeof s !== 'string') return s;
  const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','٫':'.', '٬':','};
  return s.replace(/[٠-٩٫٬]/g, d => map[d] || d).trim();
}
function logError(e){
  const el = document.getElementById('js_errors');
  const msg = (e && e.message) ? e.message : (''+e);
  el.textContent = '['+new Date().toLocaleTimeString('ar-EG',{hour12:false})+'] ' + msg + '\\n' + el.textContent;
}
window.addEventListener('error', (e) => logError(e.error || e.message));

function pushRow({ts, tf, o, h, l, c, v}){
  const rows = document.getElementById('rows');
  const lastPriceEl = document.getElementById('last_price');
  const tr = document.createElement('tr');
  tr.innerHTML = \`<td>\${new Date(ts).toLocaleTimeString('ar-EG',{hour12:false})}</td>
                   <td>\${tf}</td>
                   <td>\${(+o).toFixed(6)}</td>
                   <td>\${(+h).toFixed(6)}</td>
                   <td>\${(+l).toFixed(6)}</td>
                   <td>\${(+c).toFixed(6)}</td>
                   <td>\${v ?? '-'}</td>\`;
  rows.prepend(tr);
  while(rows.children.length>240) rows.removeChild(rows.lastChild);
  if(c !== undefined && c !== null) lastPriceEl.textContent = (+c).toFixed(6);
}
function clearRows(){ document.getElementById('rows').innerHTML=''; document.getElementById('last_price').textContent='—'; }

function setHint(t){ document.getElementById('hint_line').textContent = t || ''; }

// ===== Tabs =====
function switchTab(which){
  const paneO = document.getElementById('pane-otc');
  const paneT = document.getElementById('pane-td');
  const buttons = document.querySelectorAll('[data-cmd^="switch:"]');
  buttons.forEach(b => b.classList.add('secondary'));
  if(which === 'otc'){
    paneO.style.display='block'; paneT.style.display='none';
    document.querySelector('[data-cmd="switch:otc"]').classList.remove('secondary');
  } else {
    paneO.style.display='none'; paneT.style.display='block';
    document.querySelector('[data-cmd="switch:td"]').classList.remove('secondary');
  }
}

// ===== TwelveData =====
let tdTimer = null;
async function fetchTwelveData(){
  try{
    const sym = document.getElementById('td_symbol').value.trim();
    const key = document.getElementById('td_key').value.trim();
    const interval = document.getElementById('td_interval').value;
    if(!sym || !key){ alert('الرجاء إدخال الرمز ومفتاح TwelveData'); return; }
    document.getElementById('feed_src').textContent = 'TwelveData ' + sym + ' ' + interval;
    setHint('⏳ يجري الجلب من TwelveData…');
    const url = \`https://api.twelvedata.com/time_series?symbol=\${encodeURIComponent(sym)}&interval=\${interval}&outputsize=60&apikey=\${encodeURIComponent(key)}\`;
    const r = await fetch(url);
    const data = await r.json();
    if(!data || !data.values){ throw new Error(JSON.stringify(data)); }
    clearRows();
    for(const k of data.values.slice().reverse()){
      pushRow({ ts: new Date(k.datetime+'Z').getTime(), tf: interval, o: k.open, h: k.high, l: k.low, c: k.close, v: k.volume });
    }
    setHint('✅ تم تحديث جدول الشموع من TwelveData');
  }catch(err){ logError(err); alert('خطأ TwelveData: '+err.message); }
}
function toggleTDAuto(){
  try{
    if(tdTimer){ clearInterval(tdTimer); tdTimer=null; document.querySelector('[data-cmd="td:auto"]').textContent='تشغيل تحديث تلقائي'; return; }
    fetchTwelveData();
    tdTimer = setInterval(fetchTwelveData, 5000);
    document.querySelector('[data-cmd="td:auto"]').textContent='إيقاف التحديث التلقائي';
  }catch(err){ logError(err); }
}

// ===== Pocket Option (Socket.IO) =====
let poSocket = null;
function getPOBaseURL(){
  const server = document.getElementById('po_server').value;
  return server === 'DEMO' ? 'https://demo-api-eu.po.market' : 'https://api-eu.po.market';
}
function poSetStatus(text, cls){ const el = document.getElementById('po_status'); el.textContent=text; el.className='status '+(cls||'ok'); }
function poLog(msg){ const el = document.getElementById('po_log'); el.textContent = '['+new Date().toLocaleTimeString('ar-EG',{hour12:false})+'] '+msg + '\\n' + el.textContent; }

function parseAuth(raw){
  raw = (raw||'').trim();
  if(raw.startsWith('42[')){ const i=raw.indexOf('{'), j=raw.lastIndexOf('}'); if(i>=0 && j>i) return JSON.parse(raw.slice(i, j+1)); }
  if(raw.startsWith('{')) return JSON.parse(raw);
  throw new Error('صيغة auth غير صحيحة — الصق الرسالة كاملة التي تبدأ بـ 42[');
}

function subscribeCandles(symbol, period, limit){
  const attempts = [
    ['candles:subscribe', { asset: symbol, period, limit }],
    ['subscribe', { type: 'candles', asset: symbol, period, limit }],
    ['candles:subscribe', { active_id: symbol, timeframe: period, limit }],
    ['candles:subscribe', { asset: symbol, period, limit, market: 'otc' }],
    ['candles:history', { asset: symbol, period, limit }],
    ['history', { type: 'candles', asset: symbol, period, limit }],
  ];
  for(const [ev, payload] of attempts){
    try{ poSocket.emit(ev, payload); poLog('emit '+ev+' '+JSON.stringify(payload)); }catch(e){ poLog('emit error '+ev+' '+e.message); }
  }
}
function handleCandlePayload(p){
  const tf = document.getElementById('po_tf').value + 's';
  if(Array.isArray(p)){
    for(const k of p){
      const raw = (k.ts||k.time||k.t||k.start||Date.now());
      const ts = raw * (((''+raw).length===10)?1000:1);
      pushRow({ ts, tf, o: k.open??k.o, h: k.high??k.h, l: k.low??k.l, c: k.close??k.c, v: k.volume??k.v });
    }
    return;
  }
  if(p && (('open' in p) || ('o' in p))){
    const raw = (p.ts||p.time||p.t||p.start||Date.now());
    const ts = raw * (((''+raw).length===10)?1000:1);
    pushRow({ ts, tf, o: p.open??p.o, h: p.high??p.h, l: p.low??p.l, c: p.close??p.c, v: p.volume??p.v });
  }
}

function connectPO(){
  try{
    if(typeof io === 'undefined'){ poSetStatus('Socket.IO لم تُحمّل — جرّب فتح الملف عبر http:// بدلاً من file:// أو تأكد من الإنترنت', 'bad'); logError('socket.io JS not loaded'); return; }
    const symbol = document.getElementById('po_symbol').value.trim();
    const authRaw = document.getElementById('po_auth').value;
    const period = +toAsciiDigits(document.getElementById('po_tf').value);
    let limit = toAsciiDigits(document.getElementById('po_limit').value);
    limit = parseInt(limit, 10); if(!Number.isFinite(limit) || limit<=0) limit = 120;
    if(!symbol){ alert('أدخل رمز OTC مثل EURUSD_otc'); return; }
    const auth = parseAuth(authRaw);
    clearRows();
    document.getElementById('feed_src').textContent = 'PocketOption OTC ' + symbol + ' (Socket.IO)';
    const url = getPOBaseURL();
    poSocket = io(url, { path: '/socket.io', transports: ['websocket'] });
    poSetStatus('جاري الاتصال بـ '+url, 'warn'); poLog('connecting…');

    poSocket.on('connect', () => { poLog('connected, emitting auth'); poSocket.emit('auth', auth); });
    poSocket.on('connect_error', (e) => { poSetStatus('فشل الاتصال: '+e.message, 'bad'); poLog('connect_error: '+e.message); });
    poSocket.on('disconnect', (reason) => { poSetStatus('انقطع الاتصال: '+reason, 'warn'); poLog('disconnect: '+reason); });

    const onAuthorized = () => { poSetStatus('✔ تم التحقق — الاشتراك بالشموع', 'ok'); subscribeCandles(symbol, period, limit); };
    poSocket.on('auth_success', onAuthorized);
    poSocket.on('authorized', onAuthorized);
    poSocket.on('auth_ok', onAuthorized);

    poSocket.onAny((event, ...args) => {
      try{
        poLog('event: '+event+'  data: '+JSON.stringify(args[0]).slice(0,400));
        const d = args[0];
        if(event.includes('andle') || Array.isArray(d) || (d && (('open' in d) || ('o' in d)))) handleCandlePayload(d);
      }catch(e){ logError(e); }
    });
  }catch(err){ logError(err); poSetStatus('خطأ: '+err.message, 'bad'); }
}
function disconnectPO(){
  try{ if(poSocket){ poSocket.disconnect(); poSocket=null; poSetStatus('تم قطع الاتصال', 'warn'); } }catch(e){ logError(e); }
}

// ===== Event Delegation (one listener to rule all buttons) =====
document.body.addEventListener('click', (ev) => {
  const btn = ev.target.closest('[data-cmd]');
  if(!btn) return;
  const cmd = btn.getAttribute('data-cmd');
  setHint('👆 CLICK: '+cmd+' @ '+new Date().toLocaleTimeString('ar-EG',{hour12:false}));
  try{
    switch(cmd){
      case 'switch:otc': switchTab('otc'); break;
      case 'switch:td':  switchTab('td');  break;
      case 'po:connect': connectPO(); break;
      case 'po:disconnect': disconnectPO(); break;
      case 'td:fetch': fetchTwelveData(); break;
      case 'td:auto': toggleTDAuto(); break;
      case 'test:click': document.getElementById('test_result').textContent = '✅ تم الضغط وتم استقبال الحدث بنجاح'; break;
    }
  }catch(e){ logError(e); }
});
</script>
</body>
</html>
